<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K线图</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      #k-chart {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <canvas id="k-chart" width="800" height="700"></canvas>
    <script type="module">
      //TODO 计算坐标轴和坐标轴刻度悠问题
      import { DrawCanvas } from "../utils/drawCanvas.js";
      import { yData, xData } from "./mock.js";
      const ctxStyle = {
        font: 14,
        fillStyle: "#666",
      };
      const width = 800;
      const height = 700;
      const drawCanvas = new DrawCanvas(
        {
          id: "#k-chart",
          width,
          height,
        },
        ctxStyle
      );
      const startX = 50;
      const endX = 780;
      const startY = 0;
      const endY = 650;

      //绘制坐标系
      function drawAxis() {
        drawAxisLine();
        return {
          ...drawAxisY(),
          ...drawAxisX(),
        };
      }
      //绘制y轴
      function drawAxisY() {
        let max = Math.max(...[].concat(...yData));
        let min = Math.min(...[].concat(...yData));
        {
          // const stepYaxisDataCount =
        }
        //计算y轴刻度最大值和最小值范围
        max = Math.floor(max + max / 5);
        min = Math.floor(min - min / 5);
        //计算y轴实际高度
        const yHeight = endY - startY;
        //下面是计算y轴数字刻度数据
        // const interval = yHeight / max;
        const middleHeight = max / 5;
        let yAxisNumber = [];
        for (let i = 1; i <= 5; i++) {
          yAxisNumber.push(parseInt(middleHeight * i));
        }
        yAxisNumber = yAxisNumber.sort((a, b) => a - b);
        //计算y轴数据位置
        const startyOffet = 10; //顶部数据坐标设置为0被挡住故添加偏移量
        let yAxisPosition = [];
        const middlePosition = endY / 5;
        for (let i = 1; i <= 5; i++) {
          yAxisPosition.push(
            (yAxisNumber[i] / yAxisNumber[yAxisNumber.length - 1]) * endY
          );
        }
        yAxisPosition = yAxisPosition.sort((a, b) => b - a);
        //绘制y轴数字
        const startxOffset = 40; //x原点偏移量
        for (let i in yAxisNumber) {
          drawCanvas.drawText(
            {
              text: yAxisNumber[i],
              x: startX - startxOffset,
              y: yAxisPosition[i],
            },
            {
              font: 14,
              fillStyle: "#666",
            }
          );
        }
        return {
          yAxisNumber,
          yAxisPosition,
        };
      }
      function drawAxisX() {
        {
          const everyX = (endX - startX) / xData.length;
          const endyOffet = 20;
          for (let i = 0; i < xData.length; i++) {
            const point = {
              x: (i + 0.5) * everyX + startX,
              y: endY + endyOffet,
            };
            drawCanvas.drawText(
              {
                text: xData[i],
                ...point,
              },
              {
                font: 14,
                fillStyle: "#666",
              }
            );
          }
        }
        const middlePosition = (endY - startY) / 4;
        const endxOffset = 50; //偏移量
        let xAxisPosition = [startX, endX - endxOffset];
        for (let i = 1; i <= 3; i++) {
          xAxisPosition.push(parseInt(startX + middlePosition * i));
        }
        xAxisPosition = xAxisPosition.sort((a, b) => a - b);

        const endyOffet = 20;
        // for (let i in xAxisPosition) {
        //   drawCanvas.drawText(
        //     {
        //       text: xData[i],
        //       x: xAxisPosition[i],
        //       y: endY + endyOffet,
        //     },
        //     {
        //       font: 14,
        //       fillStyle: "#666",
        //     }
        //   );
        // }
        return {
          xAxisNumber: xData,
          xAxisPosition,
        };
      }

      //绘制坐标轴线条
      function drawAxisLine() {
        drawCanvas.lineTo({ x1: startX, y1: endY, x2: endX, y2: endY });
        drawCanvas.lineTo({ x1: startX, y1: endY, x2: startX, y2: startY });
      }
      const axisData = drawAxis();
      drawSeries(axisData, yData);
      function drawSeries(axisData, yData) {
        const { xAxisNumber, xAxisPosition, yAxisNumber } = axisData;
        const yAxisPosition = axisData.yAxisPosition.reverse();
        console.log(axisData);
        const temp = yData[0];
        //开始计算
        //-----------------------------------------------------------------

        const topLine =
          yAxisPosition[yAxisPosition.length - 1] -
          (temp[0] / yAxisNumber[yAxisNumber.length - 1]) *
            yAxisPosition[yAxisPosition.length - 1];
        console.log(topLine);
        // const bottom
        drawCanvas.lineTo({
          x1: startX + 50,
          y1: topLine,
          x2: startX + 50,
          y2: topLine - 20,
        });
      }
      function getAxisIndex(dataNumber, axisNumber) {
        return axisNumber.findIndex((number) => number > dataNumber);
      }
    </script>
  </body>
</html>
