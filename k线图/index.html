<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K线图</title>
  </head>
  <body>
    <canvas id="k-chart"></canvas>
    <script type="module">
      //TODO 计算坐标轴和坐标轴刻度悠问题
      import { DrawCanvas } from "../utils/drawCanvas.js";
      import { yData, xData } from "./mock.js";
      const ctxStyle = {
        font: 14,
        fillStyle: "#666",
      };
      const drawCanvas = new DrawCanvas(
        {
          id: "#k-chart",
          width: 800,
          height: 700,
        },
        ctxStyle
      );
      const coordX = {
        x1: 40,
        y1: 680,
        x2: 760,
        y2: 680,
      };
      const coordY = {
        x1: 40,
        y1: 680,
        x2: 40,
        y2: 40,
      };
      function drawCoords() {
        //X
        drawCanvas.lineTo(coordX);
        //Y
        drawCanvas.lineTo(coordY);
      }
      function drawCoordsY(start, end) {
        const [max, min] = yData.reduce(
          ([max, min], cur) => {
            const _max = Math.max(...cur, max);
            const _min = Math.min(...cur, min);
            return [_max, _min];
          },
          [Number.MIN_VALUE, Number.MAX_VALUE]
        );
        const residue = parseInt((max - min) / 4);
        const yList = [parseInt(min - residue)];
        const yCoords = [50];
        for (let i = 0; i <= 3; i++) {
          yList.push(yList[yList.length - 1] + residue);
        }
        for (let i = 1; i < 5; i++) {
          yCoords.push(parseInt(coordY.y1 / 4) * i);
        }
        yCoords.reverse();
        for (let i in yCoords) {
          drawCanvas.drawText({
            text: yList[i],
            x: coordX.x1 - 40,
            y: yCoords[i],
          });
        }
        return {
          axis: yList, //刻度
          position: yCoords, //位置
        };
      }
      function drawCoordsX(xData) {
        const coordsLength = coordY.y1 - coordY.y2;
        const residue = parseInt(coordsLength / (xData.length - 1));
        const xCoords = [50];
        xData.slice(1).forEach((_, i) => {
          xCoords.push(xCoords[xCoords.length - 1] + residue);
        });
        xData.forEach((number, i) => {
          drawCanvas.drawText({
            text: number,
            x: xCoords[i],
            y: coordY.y1 + 20,
          });
        });
        return xCoords;
      }

      drawCoords();

      const xAxis = drawCoordsX(xData);
      const yAxis = drawCoordsY(coordY.y2, coordY.y1);
      //绘制矩形 绘制矩形线 绘制涨跌
      function chartSeries({ xData, yData, xAxis, yAxis }) {
        const temp = yData[0];
        const { position, axis } = yAxis;
        const yHeight = position[0] - position[position.length - 1];
        const axisItem = yHeight / axis[axis.length - 1];
        console.log(axisItem);
        const rectStart = axisItem * temp[0];
        const rectEnd = axisItem * temp[1];
        const rectWidth = 15;
        const rectHeight = 40;
        console.log(rectStart, rectEnd);
        // console.log(axisItem * temp[2]);
        // drawCanvas.drawFillRect(xAxis[0], rectStart, rectWidth, rectHeight);
        candlestickCharts({
          rect: {
            x: xAxis[0],
            y: rectStart,
            width: rectWidth,
            height: rectEnd,
          },
          line: {
            topLine: {
              startPoint: {
                x: xAxis[0],
                y: axisItem * temp[2] + 5,
              },
              endPoint: {
                x: xAxis[0],
                y: axisItem * temp[2] + 10,
              },
            },
          },
        });
      }
      function candlestickCharts({ rect, line }) {
        const { width, height, x, y } = rect;
        console.log(rect);
        console.log(line);
        const {
          topLine: { startPoint, endPoint },
        } = line;
        //绘制矩形
        drawCanvas.drawFillRect(x, y, width, height, { fillStyle: "green" });
        //绘制线条
        drawCanvas.lineTo({
          x1: startPoint.x,
          y1: startPoint.y,
          x2: startPoint.x,
          y2: endPoint.y,
        });
      }
      // drawCanvas.ctx.fillStyle = "green";

      chartSeries({ xData, yData, xAxis, yAxis });
    </script>
  </body>
</html>
